{% extends "blog/base.html" %}
{% load static %}

{% block title %}{{ story.title }}{% endblock %}

{% block content %}
<div class="container">
  <!-- Хлебные крошки -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url 'blog:story_list' %}"><i class="bi bi-house-door"></i> Главная</a>
      </li>
      {% if story.category %}
        <li class="breadcrumb-item">
          <a href="{% url 'blog:category_stories' story.category.slug %}">
            <i class="bi bi-tag"></i> {{ story.category.name }}
          </a>
        </li>
      {% endif %}
      <li class="breadcrumb-item active" aria-current="page">{{ story.title|truncatewords:5 }}</li>
    </ol>
  </nav>

  <div class="row justify-content-center">
    <div class="col-lg-10 col-xl-8">
      
      <!-- Основная статья -->
      <article class="bg-white p-4 p-md-5 rounded shadow-sm mb-4">
        <!-- Заголовок -->
        <header class="mb-4">
          <h1 class="fw-bold mb-3">{{ story.title }}</h1>
          
          <!-- Мета-информация -->
          <div class="d-flex flex-wrap align-items-center gap-3 text-muted small">
            <!-- Автор -->
            <a href="{% url 'blog:user_stories' story.author.username %}" 
               class="text-decoration-none text-muted d-flex align-items-center">
              <img src="{{ story.author.profile.get_avatar_url }}"
                   class="rounded-circle me-2" 
                   width="32" 
                   height="32" 
                   alt="Аватар {{ story.author.username }}" 
                   style="object-fit: cover;">
              <strong>{{ story.author.username }}</strong>
            </a>
            
            <span>•</span>
            
            <!-- Дата публикации -->
            <span>
              <i class="bi bi-calendar"></i> 
              {{ story.published_at|date:"d F Y" }}
            </span>
            
            {% if story.category %}
              <span>•</span>
              <!-- Категория -->
              <a href="{% url 'blog:category_stories' story.category.slug %}" 
                 class="text-decoration-none">
                <span class="badge bg-primary">
                  <i class="bi bi-tag"></i> {{ story.category.name }}
                </span>
              </a>
            {% endif %}
          </div>
        </header>
        
        <!-- Обложка -->
        {% if story.cover_image %}
          <div class="mb-4">
            <img src="{{ story.cover_image_thumbnail.url }}" 
                 class="img-fluid rounded shadow-sm w-100" 
                 alt="{{ story.title }}"
                 style="max-height: 500px; object-fit: cover;">
          </div>
        {% endif %}
        
        <!-- Содержимое рассказа -->
        <div class="story-content">
          {{ story.get_markdown_content }}
        </div>

        <hr class="my-4">

        <!-- Блок с лайками и действиями -->
        <footer>
          <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <!-- Лайки -->
            <div class="d-flex align-items-center gap-2">
              {% if user.is_authenticated %}
                <form method="post" action="{% url 'blog:story_like' story.slug %}" class="d-inline">
                  {% csrf_token %}
                  <button type="submit" 
                          class="btn {% if user_likes %}btn-danger{% else %}btn-outline-danger{% endif %}">
                    <i class="bi {% if user_likes %}bi-heart-fill{% else %}bi-heart{% endif %}"></i>
                    <span class="ms-1">{{ like_count }}</span>
                  </button>
                </form>
              {% else %}
                <a href="{% url 'login' %}?next={{ request.path }}" 
                   class="btn btn-outline-danger">
                  <i class="bi bi-heart"></i>
                  <span class="ms-1">{{ like_count }}</span>
                </a>
              {% endif %}
              
              <!-- Счётчик комментариев -->
              <a href="#comments" class="btn btn-outline-secondary">
                <i class="bi bi-chat"></i>
                <span class="ms-1">{{ comments.paginator.count }}</span>
              </a>
            </div>

            <!-- Кнопки автора -->
            {% if user.is_authenticated and user == story.author %}
              <div class="d-flex gap-2">
                <a href="{% url 'blog:story_update' story.slug %}" 
                   class="btn btn-info">
                  <i class="bi bi-pencil-fill"></i> Редактировать
                </a>
                <a href="{% url 'blog:story_delete' story.slug %}" 
                   class="btn btn-danger">
                  <i class="bi bi-trash"></i> Удалить
                </a>
              </div>
            {% endif %}
          </div>
        </footer>
      </article>

      <!-- Секция комментариев -->
      <section class="comments-section" id="comments">
        <h3 class="mb-4">
          <i class="bi bi-chat-dots"></i> 
          Комментарии 
          <span class="badge bg-secondary">{{ comments.paginator.count }}</span>
        </h3>
        
        <!-- Форма добавления комментария -->
        {% if user.is_authenticated %}
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <h5 class="card-title">
                <i class="bi bi-pencil-square"></i> Оставить комментарий
              </h5>
              <form method="post" action="{% url 'blog:add_comment' story.slug %}">
                {% csrf_token %}
                <div class="mb-3">
                  <label for="{{ comment_form.content.id_for_label }}" class="form-label">
                    Ваш комментарий
                  </label>
                  {{ comment_form.content }}
                </div>
                <button type="submit" class="btn btn-primary">
                  <i class="bi bi-send"></i> Отправить
                </button>
              </form>
            </div>
          </div>
        {% else %}
          <div class="alert alert-info text-center mb-4" role="alert">
            <i class="bi bi-info-circle"></i>
            <a href="{% url 'login' %}?next={{ request.path }}" class="alert-link">Войдите</a>, 
            чтобы оставить комментарий
          </div>
        {% endif %}

        <!-- Список комментариев -->
        {% if comments %}
          <div class="d-flex flex-column gap-3">
            {% for comment in comments %}
              <div class="card shadow-sm">
                <div class="card-body">
                  <div class="d-flex align-items-start">
                    <!-- Аватар -->
                    <img src="{{ comment.author.profile.get_avatar_url }}"
                         class="rounded-circle me-3"
                         width="48" 
                         height="48" 
                         alt="Аватар {{ comment.author.username }}" 
                         style="object-fit: cover;">

                    <!-- Содержимое комментария -->
                    <div class="flex-grow-1">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <a href="{% url 'blog:user_stories' comment.author.username %}" 
                           class="text-decoration-none">
                          <strong>{{ comment.author.username }}</strong>
                        </a>
                        <small class="text-muted">
                          <i class="bi bi-clock"></i> 
                          {{ comment.created_at|timesince }} назад
                        </small>
                      </div>
                      <div class="comment-text">
                        {{ comment.content|linebreaks }}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>

          <!-- Пагинация комментариев -->
          {% if comments.has_other_pages %}
            <nav aria-label="Навигация по комментариям" class="mt-4">
              <ul class="pagination justify-content-center">

                <!-- Первая страница -->
                {% if comments.has_previous %}
                  <li class="page-item">
                    <a class="page-link" href="?page=1#comments" aria-label="Первая">
                      <span aria-hidden="true">&laquo;&laquo;</span>
                    </a>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="?page={{ comments.previous_page_number }}#comments" aria-label="Предыдущая">
                      <span aria-hidden="true">&laquo;</span>
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link">&laquo;&laquo;</span>
                  </li>
                  <li class="page-item disabled">
                    <span class="page-link">&laquo;</span>
                  </li>
                {% endif %}

                <!-- Номера страниц -->
                {% for num in comments.paginator.page_range %}
                  {% if comments.number == num %}
                    <li class="page-item active" aria-current="page">
                      <span class="page-link">{{ num }}</span>
                    </li>
                  {% elif num > comments.number|add:'-3' and num < comments.number|add:'3' %}
                    <li class="page-item">
                      <a class="page-link" href="?page={{ num }}#comments">{{ num }}</a>
                    </li>
                  {% endif %}
                {% endfor %}

                <!-- Последняя страница -->
                {% if comments.has_next %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ comments.next_page_number }}#comments" aria-label="Следующая">
                      <span aria-hidden="true">&raquo;</span>
                    </a>
                  </li>
                  <li class="page-item">
                    <a class="page-link" href="?page={{ comments.paginator.num_pages }}#comments" aria-label="Последняя">
                      <span aria-hidden="true">&raquo;&raquo;</span>
                    </a>
                  </li>
                {% else %}
                  <li class="page-item disabled">
                    <span class="page-link">&raquo;</span>
                  </li>
                  <li class="page-item disabled">
                    <span class="page-link">&raquo;&raquo;</span>
                  </li>
                {% endif %}

              </ul>
            </nav>

            <!-- Информация о пагинации -->
            <div class="text-center text-muted small mt-2">
              Страница {{ comments.number }} из {{ comments.paginator.num_pages }}
              (всего комментариев: {{ comments.paginator.count }})
            </div>
          {% endif %}
        {% else %}
          <!-- Пустое состояние -->
          <div class="card shadow-sm">
            <div class="card-body text-center py-5">
              <i class="bi bi-chat display-1 text-muted"></i>
              <h5 class="mt-3 mb-2">Комментариев пока нет</h5>
              <p class="text-muted">Станьте первым, кто оставит комментарий к этому рассказу!</p>
            </div>
          </div>
        {% endif %}
      </section>
    </div>
  </div>
</div>
{% endblock %}
