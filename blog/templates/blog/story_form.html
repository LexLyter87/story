{% extends "blog/base.html" %}
{% load static %}

{% block title %}
  {% if form.instance.pk %}Редактировать рассказ{% else %}Создать рассказ{% endif %}
{% endblock %}

{% block content %}
<div class="container">
  <!-- Хлебные крошки -->
  <nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
      <li class="breadcrumb-item">
        <a href="{% url 'blog:story_list' %}"><i class="bi bi-house-door"></i> Главная</a>
      </li>
      <li class="breadcrumb-item">
        <a href="{% url 'blog:dashboard' %}"><i class="bi bi-speedometer2"></i> Кабинет</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        {% if form.instance.pk %}
          <i class="bi bi-pencil-square"></i> Редактирование
        {% else %}
          <i class="bi bi-plus-circle"></i> Создание
        {% endif %}
      </li>
    </ol>
  </nav>

  <div class="row justify-content-center">
    <div class="col-lg-10">
      <h1 class="mb-4">
        {% if form.instance.pk %}
          <i class="bi bi-pencil-square"></i> Редактировать рассказ
        {% else %}
          <i class="bi bi-plus-circle"></i> Создать новый рассказ
        {% endif %}
      </h1>

      <div class="card shadow-sm">
        <div class="card-body p-4">
          <form method="post" enctype="multipart/form-data" id="storyForm">
            {% csrf_token %}
            
            {% if form.non_field_errors %}
              <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Ошибки в форме:</strong>
                {% for error in form.non_field_errors %}
                  <div>{{ error }}</div>
                {% endfor %}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endif %}

            {% for field in form %}
              <div class="mb-4">
                <label for="{{ field.id_for_label }}" class="form-label fw-bold">
                  {{ field.label }}
                  {% if field.field.required %}
                    <span class="text-danger">*</span>
                  {% endif %}
                </label>
                
                {{ field }}
                
                <!-- Предпросмотр обложки -->
                {% if field.name == 'cover_image' %}
                  {% if form.instance.cover_image %}
                    <div class="mt-3">
                      <p class="small text-muted mb-2">Текущая обложка:</p>
                      <img src="{{ form.instance.cover_image_thumbnail.url }}" 
                           id="currentCover" 
                           class="img-thumbnail" 
                           style="max-width: 300px; max-height: 200px; object-fit: cover;"
                           alt="Текущая обложка">
                    </div>
                  {% endif %}
                  <div id="coverPreview" class="mt-3" style="display: none;">
                    <p class="small text-muted mb-2">Предпросмотр новой обложки:</p>
                    <img id="coverPreviewImage" 
                         class="img-thumbnail" 
                         style="max-width: 300px; max-height: 200px; object-fit: cover;"
                         alt="Предпросмотр">
                  </div>
                {% endif %}
                
                {% if field.help_text %}
                  <small class="form-text text-muted d-block mt-1">
                    {{ field.help_text|safe }}
                  </small>
                {% endif %}
                
                {% for error in field.errors %}
                  <div class="invalid-feedback d-block">
                    <i class="bi bi-exclamation-circle"></i> {{ error }}
                  </div>
                {% endfor %}
              </div>
            {% endfor %}

            <div class="d-flex justify-content-between align-items-center mt-4 pt-3 border-top flex-wrap gap-3">
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-success">
                  <i class="bi bi-check-lg"></i> Сохранить
                </button>
                <a href="{% url 'blog:dashboard' %}" class="btn btn-secondary">
                  <i class="bi bi-x-circle"></i> Отмена
                </a>
              </div>

              {% if form.instance.pk %}
                <a href="{% url 'blog:story_delete' form.instance.slug %}" class="btn btn-danger">
                  <i class="bi bi-trash"></i> Удалить
                </a>
              {% endif %}
            </div>
          </form>
        </div>
      </div>
      
      <!-- Подсказка по Markdown -->
      <div class="card mt-3 bg-light border-primary border-opacity-25">
        <div class="card-body">
          <h6 class="card-title">
            <i class="bi bi-info-circle text-primary"></i> Советы по форматированию Markdown
          </h6>
          <div class="row">
            <div class="col-md-6">
              <ul class="small mb-0">
                <li><code># Заголовок 1</code> — главный заголовок</li>
                <li><code>## Заголовок 2</code> — подзаголовок</li>
                <li><code>**жирный**</code> — жирный текст</li>
                <li><code>*курсив*</code> — курсив</li>
              </ul>
            </div>
            <div class="col-md-6">
              <ul class="small mb-0">
                <li><code>[ссылка](url)</code> — гиперссылка</li>
                <li><code>- пункт</code> — маркированный список</li>
                <li><code>1. пункт</code> — нумерованный список</li>
                <li><code>> цитата</code> — блок цитаты</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Дополнительная справка -->
      <div class="alert alert-info mt-3" role="alert">
        <h6 class="alert-heading">
          <i class="bi bi-lightbulb"></i> Советы по написанию
        </h6>
        <ul class="mb-0 small">
          <li>Используйте заголовки для структурирования текста</li>
          <li>Краткое описание (excerpt) помогает привлечь читателей</li>
          <li>Загрузите обложку — рассказы с изображениями получают больше просмотров</li>
          <li>Сохраните как черновик, чтобы вернуться к редактированию позже</li>
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Подключаем медиа-файлы формы (для Markdownx) -->
{{ form.media }}

<script>
// Предпросмотр обложки
document.addEventListener('DOMContentLoaded', function() {
    const coverInput = document.querySelector('input[name="cover_image"]');
    if (coverInput) {
        coverInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('coverPreview');
                    const previewImage = document.getElementById('coverPreviewImage');
                    previewImage.src = e.target.result;
                    preview.style.display = 'block';
                    
                    // Скрываем текущую обложку
                    const currentCover = document.getElementById('currentCover');
                    if (currentCover) {
                        currentCover.style.display = 'none';
                    }
                };
                reader.readAsDataURL(file);
            }
        });
    }
    
    // Валидация формы
    const form = document.getElementById('storyForm');
    form.addEventListener('submit', function(e) {
        const title = form.querySelector('input[name="title"]');
        const content = form.querySelector('textarea[name="content"]');
        
        if (!title || !title.value.trim()) {
            e.preventDefault();
            alert('Пожалуйста, введите заголовок рассказа');
            title.focus();
            return false;
        }
        
        if (!content || !content.value.trim()) {
            e.preventDefault();
            alert('Пожалуйста, напишите текст рассказа');
            content.focus();
            return false;
        }
    });
});
</script>
{% endblock %}
